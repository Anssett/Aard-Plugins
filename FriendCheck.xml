<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Friday, April 05, 2024, 4:19 PM -->
<!-- MuClient version 5.07-pre -->

<!-- Plugin "FriendCheck" generated by Plugin Wizard -->

<muclient>
<plugin
   name="FriendCheck"
   author="Anssett"
   id="1322d656cc4da6f69a508abb"
   language="Lua"
   purpose="Brief data on a friend that just logged on - now with wrapped captures. maybe."
   save_state="y"
   date_written="2024-04-05 16:17:22"
   requires="5.07"
   version="1.0"
   >
   <description trim="n">
    <![CDATA[
FriendCheck
------------
"fc (on|off)" to enable/disable

]]>
</description>

</plugin>


<!--  Triggers  -->

<triggers>
  <trigger group="friendCheck" enabled="y" expand_variables="y" keep_evaluating="y" match="^\(Friend\): (?<name>\w+) has entered Aardwolf\.$" regexp="y" omit_from_output="y" script="startCheck" sequence="100"></trigger>
</triggers>

<!--  Plugin help  -->

<aliases>
  <alias script="OnHelp" match="fc help" enabled="y"></alias>
  <alias script="toggle" match="^fc (?<toggle>(on|off))$" enabled="y" regexp="y"></alias>
</aliases>

<script>
<![CDATA[

require "wrapped_captures"
require "aardwolf_colors"

morts=1
level=0
race=""
subclass=""
tier=0
name=""

function OnHelp ()
  world.Note (world.GetPluginInfo (world.GetPluginID (), 3))
end

function toggle(name,line, args)
  if args.toggle=="on" then
    EnableTriggerGroup("friendCheck",true)
    SendNoEcho("echo @CFriendCheck Plugin Enabled@w")
  elseif args.toggle=="off" then
    EnableTriggerGroup("friendCheck",false)
    SendNoEcho("echo @YFriendCheck plugin disabled@w")
  end
end


function friendCap(name)
  friendData = {
    name=name,
    level="",
    gender = "",
    race = "",
    subclass = "",
    tier = "",
    morts = "1"
  }
  command = "finger " .. name
  startLine = "^\\-+ Player : (?:\\w+) \\(.*\\) \\-+$"
  stopLine = "^\\-{60}$"
  tagsAreRegex=true
  noCommandEcho=true
  omitResponse=true
  noFollowPrompt=false
  sendViaExecute=true
    
  Capture.tagged_output(command,startLine,stopLine,tagsAreRegex,noCommandEcho,omitResponse,noFollowPrompt,processCapture,sendViaExecute,failCapture)
end

function processCapture(lines)
  new_table = {}
  for k, v in ipairs(lines) do
      stripped = strip_colours_from_styles(v)
      if stripped ~= "" then
          table.insert(new_table, stripped)
      end
  end

  for i,j in ipairs(new_table) do
      if string.find(j,"^Remort: ") ~=nil then --check for "remort" in string
        friendData.morts = countMorts(j)
      elseif string.find(j,"^Level %d+ ") ~= nil then --check for level line
        friendData.level, friendData.gender, friendData.race, friendData.subclass, friendData.tier = string.match(j, "Level (%d+) (%w+) ([%w%s-]+) (%w+) %[?%w*%]?%s?%(Tier (%d+%+?%d*)%)%.$")
      end
  end
  outFriend = friendBuild()
  SendNoEcho("echo ".. outFriend)
end

function failCapture()
    Note("Capture timed out")
end

function countMorts(remortString)
  mortcount = (select(2,string.gsub(remortString,"/","")))+1
  return mortcount
end


function startCheck(name, line, args)
  name=args.name
  friendCap(name)
end

function friendBuild()
  return "@G(Friend) @C"..  friendData.name .. " has entered Aardwolf. (".. friendData.level .. " T" .. friendData.tier .. " R"..friendData.morts.. " " .. friendData.race .. " " .. friendData.subclass .. ")@w"
end

function dump(o)
    if type(o) == 'table' then
       local s = '{ '
       for k,v in pairs(o) do
          if type(k) ~= 'number' then k = '"'..k..'"' end
          s = s .. '['..k..'] = ' .. dump(v) .. ','
       end
       return s .. '} '
    else
       return tostring(o)
    end
 end

]]>


</script> 

</muclient>
